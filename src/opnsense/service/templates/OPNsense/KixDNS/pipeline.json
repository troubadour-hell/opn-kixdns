{#
 # KixDNS Pipeline Configuration Template
 # Copyright (C) 2025 KixDNS Project
 # All rights reserved.
 #
 # Strategy: If config_json is set, output it directly.
 # Otherwise, output a minimal default configuration.
 #}
{% if helpers.exists('OPNsense.kixdns.general.config_json') and OPNsense.kixdns.general.config_json|default('') != '' %}
{{ OPNsense.kixdns.general.config_json }}
{% else %}
{
    "version": "1.0",
    "settings": {
{% if helpers.exists('OPNsense.kixdns.general') %}
        "bind_udp": "{{ OPNsense.kixdns.general.bind_udp|default('0.0.0.0:5353') }}",
        "bind_tcp": "{{ OPNsense.kixdns.general.bind_tcp|default('0.0.0.0:5353') }}",
        "default_upstream": "{{ OPNsense.kixdns.general.default_upstream|default('1.1.1.1:53') }}",
        "upstream_timeout_ms": {{ OPNsense.kixdns.general.upstream_timeout|default('2000')|int }},
        "min_ttl": {{ OPNsense.kixdns.general.min_ttl|default('0')|int }},
        "response_jump_limit": {{ OPNsense.kixdns.general.response_jump_limit|default('10')|int }},
        "udp_pool_size": {{ OPNsense.kixdns.general.udp_pool_size|default('0')|int }}
{% else %}
        "bind_udp": "0.0.0.0:5353",
        "bind_tcp": "0.0.0.0:5353",
        "default_upstream": "1.1.1.1:53",
        "upstream_timeout_ms": 2000,
        "min_ttl": 0,
        "response_jump_limit": 10,
        "udp_pool_size": 0
{% endif %}
    },
    "pipeline_select": [],
    "pipelines": [
        {
            "id": "main",
            "rules": [
                {
                    "name": "default_forward",
                    "matchers": [{ "type": "any" }],
                    "actions": [{ "type": "forward", "upstream": null }]
                }
            ]
        }
    ]
}
{% endif %}
