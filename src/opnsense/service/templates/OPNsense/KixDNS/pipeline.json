{
    "version": "1.0",
    "settings": {
        "bind_udp": "{{ OPNsense.get('kixdns', {}).get('general', {}).get('bind_udp', '0.0.0.0:5353') }}",
        "bind_tcp": "{{ OPNsense.get('kixdns', {}).get('general', {}).get('bind_tcp', '0.0.0.0:5353') }}",
        "default_upstream": "{{ OPNsense.get('kixdns', {}).get('general', {}).get('default_upstream', '1.1.1.1:53') }}",
        "upstream_timeout_ms": {{ OPNsense.get('kixdns', {}).get('general', {}).get('upstream_timeout', 2000) }},
        "min_ttl": {{ OPNsense.get('kixdns', {}).get('general', {}).get('min_ttl', 0) }},
        "response_jump_limit": {{ OPNsense.get('kixdns', {}).get('general', {}).get('response_jump_limit', 10) }},
        "udp_pool_size": {{ OPNsense.get('kixdns', {}).get('general', {}).get('udp_pool_size', 0) }},
        "udp_workers": {{ OPNsense.get('kixdns', {}).get('general', {}).get('udp_workers', 0) }}
    },
    "pipelines": [
{% if helpers.exists('OPNsense.kixdns.pipelines.pipeline') %}
    {% for pipe in helpers.toList('OPNsense.kixdns.pipelines.pipeline') %}
        {
            "id": "{{ pipe.id }}",
            "rules": [
        {% if helpers.exists('OPNsense.kixdns.rules.rule') %}
            {% set first_rule = true %}
            {% for rule in helpers.toList('OPNsense.kixdns.rules.rule') %}
                {% if rule.pipeline_id == pipe.id and rule.enabled == '1' %}
                {% if not first_rule %},{% endif %}
                {% set first_rule = false %}
                {
                    "name": "{{ rule.name }}",
                    "matchers": {{ rule.matchers | default('[]') }},
                    "matcher_operator": "{{ rule.matcher_operator }}",
                    "actions": {{ rule.actions | default('[]') }},
                    "response_matchers": {{ rule.response_matchers | default('[]') }}
                }
                {% endif %}
            {% endfor %}
        {% endif %}
            ]
        }{% if not loop.last %},{% endif %}
    {% endfor %}
{% endif %}
    ],
    "pipeline_select": [
{% if helpers.exists('OPNsense.kixdns.selectors.selector') %}
    {% for sel in helpers.toList('OPNsense.kixdns.selectors.selector') %}
        {
            "pipeline": "{{ sel.target_pipeline }}",
            "matchers": {{ sel.matchers | default('[]') }},
            "matcher_operator": "{{ sel.operator }}"
        }{% if not loop.last %},{% endif %}
    {% endfor %}
{% endif %}
    ]
}

